
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>openatom.merge_systems &#8212; atom 0.0.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=5db94ae7"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/openatom/merge_systems';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.png" class="logo__image only-light" alt="atom 0.0.0 documentation - Home"/>
    <script>document.write(`<img src="../../_static/logo.png" class="logo__image only-dark" alt="atom 0.0.0 documentation - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../examples.html">Examples</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../examples/relative-hydration-free-energy-benzene-phenol/main.html">Relative hydration free energy calculation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/relative-binding-free-energy-protein-ligand/main.html">Relative binding free energy calculation</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../../API.html">API</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/DingGroup/openatom" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1></h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for openatom.merge_systems</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Iterator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">ndarray</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">openmm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">openmm.app</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xml.etree.ElementTree</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ET</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.spatial.transform</span><span class="w"> </span><span class="kn">import</span> <span class="n">Rotation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">combinations</span><span class="p">,</span> <span class="n">product</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">openatom.mcs</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_graph</span>


<div class="viewcode-block" id="make_alchemical_system">
<a class="viewcode-back" href="../../API.html#openatom.make_alchemical_system">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">make_alchemical_system</span><span class="p">(</span>
    <span class="n">ligs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">],</span>
    <span class="n">lig_tops</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">openmm</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">Topology</span><span class="p">],</span>
    <span class="n">lig_common_particles</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
    <span class="n">lig_coors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">lambdas</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span>
    <span class="n">environment</span><span class="p">:</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">,</span>
    <span class="n">environment_top</span><span class="p">:</span> <span class="n">openmm</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">Topology</span><span class="p">,</span>
    <span class="n">environment_coor</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make an alchemical system from ligands and environment.</span>
<span class="sd">    </span>
<span class="sd">    This function merges the ligands and the environment into an alchemical system using the double topology approach. The alchemical system contains one copy of the common particles shared by all the ligands and the environment, and one copy of the soft-core particles from each ligand.</span>
<span class="sd">    Soft-core particles from each ligand are bonded to the common particles. </span>

<span class="sd">    Args:</span>
<span class="sd">        ligs (List[ET.Element]): List of XML elements of the ligands.</span>
<span class="sd">            Each element should be the root of the ligand XML tree.</span>
<span class="sd">        lig_tops (List[openmm.app.Topology]): List of OpenMM topology objects of the ligands.</span>
<span class="sd">        lig_common_particles (List[List[int]]): List of lists of indices of common particles in the ligands.</span>
<span class="sd">        lig_coors (List[ndarray]): List of coordinates of the ligands.</span>
<span class="sd">        lambdas (List[Tuple[float, float]]): List of lambda values for electrostatic and van der Waals interactions.</span>
<span class="sd">        environment (ET.Element): XML element of the environment.</span>
<span class="sd">            It should be the root of the environment XML tree.</span>
<span class="sd">        environment_top (openmm.app.Topology): OpenMM topology object of the environment.</span>
<span class="sd">        environment_coor (ndarray): Coordinates of the environment.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[ET.Element, openmm.app.Topology, ndarray]: Tuple of the XML element of the alchemical system, the OpenMM topology object of the alchemical system, and the coordinates of the alchemical system.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lig_graphs</span> <span class="o">=</span> <span class="p">[</span><span class="n">make_graph</span><span class="p">(</span><span class="n">lig_top</span><span class="p">)</span> <span class="k">for</span> <span class="n">lig_top</span> <span class="ow">in</span> <span class="n">lig_tops</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">ligand</span><span class="p">,</span> <span class="n">common_atoms</span><span class="p">,</span> <span class="n">graph</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ligs</span><span class="p">,</span> <span class="n">lig_common_particles</span><span class="p">,</span> <span class="n">lig_graphs</span><span class="p">):</span>
        <span class="n">label_particles</span><span class="p">(</span><span class="n">ligand</span><span class="p">,</span> <span class="n">common_atoms</span><span class="p">,</span> <span class="n">graph</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">environment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">system</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;System&quot;</span><span class="p">,</span> <span class="n">environment</span><span class="o">.</span><span class="n">attrib</span><span class="p">)</span>
        <span class="n">system</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./PeriodicBoxVectors&quot;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">system</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;System&quot;</span><span class="p">,</span> <span class="n">ligs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">attrib</span><span class="p">)</span>
        <span class="n">system</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ligs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./PeriodicBoxVectors&quot;</span><span class="p">))</span>

    <span class="n">particles</span><span class="p">,</span> <span class="n">topology</span> <span class="o">=</span> <span class="n">_merge_particles_and_topologies</span><span class="p">(</span>
        <span class="n">ligs</span><span class="p">,</span> <span class="n">lig_tops</span><span class="p">,</span> <span class="n">lig_common_particles</span><span class="p">,</span> <span class="n">environment</span><span class="p">,</span> <span class="n">environment_top</span>
    <span class="p">)</span>
    <span class="n">system</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">particles</span><span class="p">)</span>

    <span class="n">constraints</span> <span class="o">=</span> <span class="n">_merge_constraints</span><span class="p">(</span><span class="n">ligs</span><span class="p">,</span> <span class="n">environment</span><span class="p">)</span>
    <span class="n">system</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>

    <span class="n">forces</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="s2">&quot;Forces&quot;</span><span class="p">)</span>

    <span class="n">force</span> <span class="o">=</span> <span class="n">_merge_harmonic_bonds</span><span class="p">(</span><span class="n">ligs</span><span class="p">,</span> <span class="n">lambdas</span><span class="p">,</span> <span class="n">environment</span><span class="p">)</span>
    <span class="n">forces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>

    <span class="n">force</span> <span class="o">=</span> <span class="n">_merge_harmonic_angles</span><span class="p">(</span><span class="n">ligs</span><span class="p">,</span> <span class="n">lambdas</span><span class="p">,</span> <span class="n">environment</span><span class="p">)</span>
    <span class="n">forces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>

    <span class="n">force</span> <span class="o">=</span> <span class="n">_merge_periodic_torsions</span><span class="p">(</span><span class="n">ligs</span><span class="p">,</span> <span class="n">lambdas</span><span class="p">,</span> <span class="n">environment</span><span class="p">)</span>
    <span class="n">forces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>

    <span class="n">force</span> <span class="o">=</span> <span class="n">_merge_nonbonded_forces</span><span class="p">(</span><span class="n">ligs</span><span class="p">,</span> <span class="n">lambdas</span><span class="p">,</span> <span class="n">environment</span><span class="p">)</span>
    <span class="n">forces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>

    <span class="n">force</span> <span class="o">=</span> <span class="n">_make_custom_nonbonded_force</span><span class="p">(</span><span class="n">ligs</span><span class="p">,</span> <span class="n">lambdas</span><span class="p">,</span> <span class="n">environment</span><span class="p">)</span>
    <span class="n">forces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>

    <span class="n">force</span> <span class="o">=</span> <span class="n">_make_cmmotion_remover</span><span class="p">()</span>
    <span class="n">forces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lig_coors</span><span class="p">)):</span>
        <span class="n">lig_coors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">align_coordinates</span><span class="p">(</span>
            <span class="n">lig_coors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lig_coors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lig_common_particles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lig_common_particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">lig_coors</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">lig_common_particles</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">lig_coors</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">lig_common_particles</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;./Particles/Particle&quot;</span><span class="p">))</span>
    <span class="n">coor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">idx_lig</span><span class="p">,</span> <span class="p">(</span><span class="n">lig</span><span class="p">,</span> <span class="n">lig_coor</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ligs</span><span class="p">,</span> <span class="n">lig_coors</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lig</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Particles/Particle&quot;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">idx_lig</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">))</span>
                <span class="n">coor</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">lig_coor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;soft-core&quot;</span><span class="p">:</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">))</span>
                    <span class="n">coor</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">lig_coor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">environment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Particles/Particle&quot;</span><span class="p">)):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">))</span>
            <span class="n">coor</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">environment_coor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">coor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coor</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">system</span><span class="p">,</span> <span class="n">topology</span><span class="p">,</span> <span class="n">coor</span></div>



<div class="viewcode-block" id="align_coordinates">
<a class="viewcode-back" href="../../API.html#openatom.align_coordinates">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">align_coordinates</span><span class="p">(</span>
    <span class="n">x1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">x2</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">atoms1</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">atoms2</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Align the coordinates of x2 to x1 using the atoms specified in atoms1 and atoms2.</span>

<span class="sd">    The coordinates of x2 are first rotated and translated to minimize the RMSD between x1[atom1] and x2[atom2]. Then the coordinates of x2[atom2] are set to x1[atom1].</span>

<span class="sd">    Args:</span>
<span class="sd">        x1 (np.ndarray): Coordinates of the first molecule.</span>
<span class="sd">        x2 (np.ndarray): Coordinates of the second molecule.</span>
<span class="sd">        atoms1 (list[int]): List of atom indices of the first molecule.</span>
<span class="sd">        atoms2 (list[int]): List of atom indices of the second molecule.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray: Aligned coordinates of the second molecule.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x1_center</span> <span class="o">=</span> <span class="n">x1</span><span class="p">[</span><span class="n">atoms1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">x2_center</span> <span class="o">=</span> <span class="n">x2</span><span class="p">[</span><span class="n">atoms2</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">x2_center</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">Rotation</span><span class="o">.</span><span class="n">align_vectors</span><span class="p">(</span><span class="n">x1</span><span class="p">[</span><span class="n">atoms1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x1_center</span><span class="p">,</span> <span class="n">x2</span><span class="p">[</span><span class="n">atoms2</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">+</span> <span class="n">x1_center</span>
    <span class="n">x2</span><span class="p">[</span><span class="n">atoms2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x1</span><span class="p">[</span><span class="n">atoms1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">x2</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">label_particles</span><span class="p">(</span>
    <span class="n">ligand</span><span class="p">:</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">,</span> <span class="n">common_particles</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">graph</span><span class="p">:</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; This function has two main purposes:</span>
<span class="sd">    1. Label the particles in a ligand based on the common substructure and the graph of the ligand.</span>
<span class="sd">    2. Find the bonded terms between common particles and soft-core particles that will be kept when the soft-core particles&#39; nonbonded interactions are turned off.</span>
<span class="sd">    </span>
<span class="sd">    Every particle has a &quot;class&quot; attribute which can be either &quot;common&quot; or &quot;soft-core&quot;. The common</span>
<span class="sd">    particles are the particles that are in the common substructure. The soft-core particles are</span>
<span class="sd">    the particles that are not in the common substructure. For each soft-core particle, it has an</span>
<span class="sd">    &quot;attach_idx&quot; attribute which is the index of the common particle through which it is connected</span>
<span class="sd">    to the common substructure.</span>

<span class="sd">    Args:</span>
<span class="sd">        ligand (ET.Element): XML element of the ligand.</span>
<span class="sd">            It should be the root of the ligand XML tree.</span>
<span class="sd">        common_particles (list[int]): List of indices of common particles in the ligand.</span>
<span class="sd">        graph (nx.Graph): NetworkX graph of the ligand.</span>

<span class="sd">    Note that the function modifies the input ligand and does not return anything.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#### label particles in the ligand</span>

    <span class="c1">## common particle set</span>
    <span class="n">cps</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">common_particles</span><span class="p">)</span>

    <span class="c1">## label particles&#39; class as common or soft-core</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ligand</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Particles/Particle&quot;</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cps</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;common&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;soft-core&quot;</span><span class="p">)</span>

    <span class="c1">## label soft-core particles&#39; attach_idx using breadth-first search</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">nx</span><span class="o">.</span><span class="n">bfs_edges</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">common_particles</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">cps</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cps</span><span class="p">):</span>
            <span class="n">ligand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;attach_idx&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cps</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cps</span><span class="p">):</span>
            <span class="n">ligand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="s2">&quot;attach_idx&quot;</span><span class="p">,</span> <span class="n">ligand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;attach_idx&quot;</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="c1">#### add bonded terms to the ligand</span>
    <span class="c1">#### In alchemical free energy calculations, we need to be careful about the bonded terms</span>
    <span class="c1">#### between common particles and soft-core particles.</span>
    <span class="c1">#### When the soft-core particles&#39; nonbonded interactions are turned off, the bonded terms</span>
    <span class="c1">#### between common particles and soft-core particles are needed for the following reasons:</span>
    <span class="c1">#### 1. they can keep the soft-core particles from drifting away from the common particles</span>
    <span class="c1">#### 2. they can maintain the geometry of the soft-core particles to increase the phase space overlap</span>
    <span class="c1">#### However, we don&#39;t want these bonded terms to distort the common particles&#39; geometry.    </span>
    
    <span class="c1">## soft-core particle set</span>
    <span class="n">scps</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">())</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cps</span><span class="p">])</span>

    
    <span class="c1">## compute shortest path lengths from each soft-core particle to common particles    </span>
    <span class="n">dist_from_cp_to_scp</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cps</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">lengths</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">single_target_shortest_path_length</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="c1">## currently nx.single_target_shortest_path_length returns an iterator</span>
        <span class="c1">## starting from v3.5, it will return a dictionary</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lengths</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">):</span>
            <span class="n">lengths</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">lengths</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">cps</span><span class="p">:</span>
                <span class="n">dist_from_cp_to_scp</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dist_from_cp_to_scp</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">dist_from_cp_to_scp</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="n">start_node</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dist_from_cp_to_scp</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">dist_from_cp_to_scp</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
    <span class="n">predecessors</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">dfs_predecessors</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">start_node</span><span class="p">)</span>

    <span class="n">bonded_terms</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;BondedTerms&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">scps</span><span class="p">:</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">predecessors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">cps</span><span class="p">:</span>
            <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">bonded_terms</span><span class="p">,</span> <span class="s2">&quot;Bond&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;p1&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="s2">&quot;p2&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)})</span>

        <span class="n">k</span> <span class="o">=</span> <span class="n">predecessors</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">cps</span> <span class="ow">or</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cps</span><span class="p">:</span>
            <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span>
                <span class="n">bonded_terms</span><span class="p">,</span> <span class="s2">&quot;Angle&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;p1&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="s2">&quot;p2&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="s2">&quot;p3&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)}</span>
            <span class="p">)</span>

        <span class="n">h</span> <span class="o">=</span> <span class="n">predecessors</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">cps</span> <span class="ow">or</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cps</span> <span class="ow">or</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">cps</span><span class="p">:</span>
            <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span>
                <span class="n">bonded_terms</span><span class="p">,</span>
                <span class="s2">&quot;Torsion&quot;</span><span class="p">,</span>
                <span class="p">{</span><span class="s2">&quot;p1&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="s2">&quot;p2&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="s2">&quot;p3&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="s2">&quot;p4&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">h</span><span class="p">)},</span>
            <span class="p">)</span>

    <span class="n">ligand</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bonded_terms</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_merge_particles_and_topologies</span><span class="p">(</span>
    <span class="n">ligands</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">],</span>
    <span class="n">ligand_topologies</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">openmm</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">Topology</span><span class="p">],</span>
    <span class="n">common_particles</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
    <span class="n">environment</span><span class="p">:</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">,</span>
    <span class="n">environment_topology</span><span class="p">:</span> <span class="n">openmm</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">Topology</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Merge the particles and topologies of ligands and environment.</span>

<span class="sd">    Because ligands share common particles, the common particles are only added once to the</span>
<span class="sd">    merged particles. Soft-core particles are added from all ligands. The environment particles</span>
<span class="sd">    are added as well. As the particles are added, their indices in the merged particles are</span>
<span class="sd">    recorded in the &quot;idx&quot; attribute of the particles in the ligands and the environment, which</span>
<span class="sd">    is the intended side effect of this function.</span>

<span class="sd">    Args:</span>
<span class="sd">        ligands (list[ET.Element]): List of XML elements of the ligands.</span>
<span class="sd">            Each element should be the root of the ligand XML tree.</span>
<span class="sd">        ligand_topologies (list[openmm.app.Topology]): List of OpenMM topology objects of the</span>
<span class="sd">            ligands.</span>
<span class="sd">        common_particles (list[list[int]]): List of lists of indices of common particles in the</span>
<span class="sd">            ligands.</span>
<span class="sd">        environment (ET.Element): XML element of the environment.</span>
<span class="sd">            It should be the root of the environment XML tree.</span>
<span class="sd">        environment_topology (openmm.app.Topology): OpenMM topology object of the environment.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[ET.Element, openmm.app.Topology]: Tuple of the XML element of the merged particles and</span>
<span class="sd">            the OpenMM topology object of the merged system.</span>

<span class="sd">    Note that the function has an intended side effect of setting the &quot;idx&quot; attribute of the</span>
<span class="sd">    particles in the ligands and the environment.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">particles</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;Particles&quot;</span><span class="p">)</span>
    <span class="n">topology</span> <span class="o">=</span> <span class="n">openmm</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">Topology</span><span class="p">()</span>

    <span class="n">ligand_atoms</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">lig_top</span><span class="o">.</span><span class="n">atoms</span><span class="p">())</span> <span class="k">for</span> <span class="n">lig_top</span> <span class="ow">in</span> <span class="n">ligand_topologies</span><span class="p">]</span>

    <span class="c1">## add common particles from the first ligand and label common particles in all ligands</span>
    <span class="n">chain</span> <span class="o">=</span> <span class="n">topology</span><span class="o">.</span><span class="n">addChain</span><span class="p">()</span>
    <span class="n">residue</span> <span class="o">=</span> <span class="n">topology</span><span class="o">.</span><span class="n">addResidue</span><span class="p">(</span><span class="s2">&quot;LIG&quot;</span><span class="p">,</span> <span class="n">chain</span><span class="p">)</span>

    <span class="n">p_idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">atom_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">common_particles</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
        <span class="n">lig</span> <span class="o">=</span> <span class="n">ligands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">common_particles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span>
            <span class="n">particles</span><span class="p">,</span> <span class="s2">&quot;Particle&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="n">lig</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">)}</span>
        <span class="p">)</span>
        <span class="n">lig</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">p_idx</span><span class="p">))</span>

        <span class="n">atom</span> <span class="o">=</span> <span class="n">ligand_atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
        <span class="n">topology</span><span class="o">.</span><span class="n">addAtom</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="n">residue</span><span class="p">)</span>
        <span class="n">atom_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ligands</span><span class="p">)):</span>
            <span class="n">lig</span> <span class="o">=</span> <span class="n">ligands</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">common_particles</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">lig</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">p_idx</span><span class="p">))</span>

        <span class="n">p_idx</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1">## add soft-core particles from all ligands</span>
    <span class="k">for</span> <span class="n">lig</span><span class="p">,</span> <span class="n">atoms</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ligands</span><span class="p">,</span> <span class="n">ligand_atoms</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lig</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Particles/Particle&quot;</span><span class="p">),</span> <span class="n">atoms</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;soft-core&quot;</span><span class="p">:</span>
                <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">particles</span><span class="p">,</span> <span class="s2">&quot;Particle&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">)})</span>
                <span class="n">p</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">p_idx</span><span class="p">))</span>
                <span class="n">p_idx</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1">## soft-core particles from different ligands may have the same name</span>
                <span class="c1">## so we need to check and increment the name if necessary to avoid</span>
                <span class="c1">## name conflicts in the topology. This is necessary only for topology</span>
                <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atom_names</span><span class="p">:</span>
                    <span class="n">topology</span><span class="o">.</span><span class="n">addAtom</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="n">residue</span><span class="p">)</span>
                    <span class="n">atom_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span>
                    <span class="k">while</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">atom_names</span><span class="p">:</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">_increment_atom_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">topology</span><span class="o">.</span><span class="n">addAtom</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="n">residue</span><span class="p">)</span>
                    <span class="n">atom_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="c1">## add envirionment particles</span>
    <span class="k">if</span> <span class="n">environment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">chain</span> <span class="o">=</span> <span class="n">topology</span><span class="o">.</span><span class="n">addChain</span><span class="p">()</span>
        <span class="n">residue</span> <span class="o">=</span> <span class="n">topology</span><span class="o">.</span><span class="n">addResidue</span><span class="p">(</span><span class="s2">&quot;ENV&quot;</span><span class="p">,</span> <span class="n">chain</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">environment_topology</span><span class="o">.</span><span class="n">chains</span><span class="p">():</span>
            <span class="n">new_chain</span> <span class="o">=</span> <span class="n">topology</span><span class="o">.</span><span class="n">addChain</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">chain</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="n">chain</span><span class="o">.</span><span class="n">residues</span><span class="p">():</span>
                <span class="n">new_residue</span> <span class="o">=</span> <span class="n">topology</span><span class="o">.</span><span class="n">addResidue</span><span class="p">(</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">new_chain</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">residue</span><span class="o">.</span><span class="n">atoms</span><span class="p">():</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">particles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">p_idx</span><span class="p">))</span>
                    <span class="n">p_idx</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="n">topology</span><span class="o">.</span><span class="n">addAtom</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="n">new_residue</span><span class="p">)</span>

    <span class="c1">## add bonds to the topology</span>
    <span class="n">topology_atoms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">topology</span><span class="o">.</span><span class="n">atoms</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">lig</span><span class="p">,</span> <span class="n">lig_top</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ligands</span><span class="p">,</span> <span class="n">ligand_topologies</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">lig_top</span><span class="o">.</span><span class="n">bonds</span><span class="p">():</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">index</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lig</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">))</span>
            <span class="n">j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lig</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">))</span>
            <span class="n">topology</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="n">topology_atoms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">topology_atoms</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">environment_topology</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">environment_topology</span><span class="o">.</span><span class="n">bonds</span><span class="p">():</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">index</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">))</span>
            <span class="n">j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">))</span>
            <span class="n">topology</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="n">topology_atoms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">topology_atoms</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

    <span class="c1">## set periodic box vectors</span>
    <span class="k">if</span> <span class="n">environment_topology</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">topology</span><span class="o">.</span><span class="n">setPeriodicBoxVectors</span><span class="p">(</span><span class="n">environment_topology</span><span class="o">.</span><span class="n">getPeriodicBoxVectors</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">ligand_topologies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getPeriodicBoxVectors</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">topology</span><span class="o">.</span><span class="n">setPeriodicBoxVectors</span><span class="p">(</span><span class="n">ligand_topologies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getPeriodicBoxVectors</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">particles</span><span class="p">,</span> <span class="n">topology</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_merge_constraints</span><span class="p">(</span>
    <span class="n">ligands</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">],</span> <span class="n">environment</span><span class="p">:</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Merge the constraints of ligands and environment.</span>

<span class="sd">    The constraints of the ligands among common particles are added once to the merged constraints</span>
<span class="sd">    using the constraints from the first ligand. The constraints involving soft-core particles</span>
<span class="sd">    are added from all ligands. The constraints from the environment are added as well.</span>

<span class="sd">    Args:</span>
<span class="sd">        ligands (list[ET.Element]): List of XML elements of the ligands.</span>
<span class="sd">            Each element should be the root of the ligand XML tree.</span>
<span class="sd">        environment (ET.Element): XML element of the environment.</span>
<span class="sd">            It should be the root of the environment XML tree.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ET.Element: XML element of the merged constraints.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cons</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;Constraints&quot;</span><span class="p">)</span>

    <span class="c1">## add constraints from the ligands</span>
    <span class="k">for</span> <span class="n">idx_lig</span><span class="p">,</span> <span class="n">lig</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ligands</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">lig</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Constraints/Constraint&quot;</span><span class="p">):</span>
            <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p1&quot;</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p2&quot;</span><span class="p">))</span>
            <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span> <span class="o">=</span> <span class="n">_get_idx</span><span class="p">(</span><span class="n">lig</span><span class="p">,</span> <span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">])</span>
            <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">j1</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">j2</span><span class="p">)</span>

            <span class="c1">## all all constraints from the first ligand</span>
            <span class="k">if</span> <span class="n">idx_lig</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">cons</span><span class="p">,</span> <span class="s2">&quot;Constraint&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">),</span> <span class="s2">&quot;p1&quot;</span><span class="p">:</span> <span class="n">j1</span><span class="p">,</span> <span class="s2">&quot;p2&quot;</span><span class="p">:</span> <span class="n">j2</span><span class="p">})</span>

            <span class="c1">## only add constraints involving soft-core particles from other ligands</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">lig</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;soft-core&quot;</span>
                    <span class="ow">or</span> <span class="n">lig</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i2</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;soft-core&quot;</span>
                <span class="p">):</span>
                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span>
                        <span class="n">cons</span><span class="p">,</span> <span class="s2">&quot;Constraint&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">),</span> <span class="s2">&quot;p1&quot;</span><span class="p">:</span> <span class="n">j1</span><span class="p">,</span> <span class="s2">&quot;p2&quot;</span><span class="p">:</span> <span class="n">j2</span><span class="p">}</span>
                    <span class="p">)</span>

    <span class="c1">## add constraints from the environment</span>
    <span class="k">if</span> <span class="n">environment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">environment</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Constraints/Constraint&quot;</span><span class="p">):</span>
            <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p1&quot;</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p2&quot;</span><span class="p">))</span>
            <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span> <span class="o">=</span> <span class="n">_get_idx</span><span class="p">(</span><span class="n">environment</span><span class="p">,</span> <span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">])</span>
            <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">j1</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">j2</span><span class="p">)</span>
            <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">cons</span><span class="p">,</span> <span class="s2">&quot;Constraint&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">),</span> <span class="s2">&quot;p1&quot;</span><span class="p">:</span> <span class="n">j1</span><span class="p">,</span> <span class="s2">&quot;p2&quot;</span><span class="p">:</span> <span class="n">j2</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">cons</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_idx</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">,</span> <span class="n">idxs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_merge_harmonic_bonds</span><span class="p">(</span>
    <span class="n">ligands</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">],</span> <span class="n">lambdas</span><span class="p">:</span> <span class="nb">list</span><span class="p">[(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span> <span class="n">environment</span><span class="p">:</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">:</span>
    <span class="n">force</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span>
        <span class="s2">&quot;Force&quot;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;forceGroup&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;HarmonicBondForce&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;HarmonicBondForce&quot;</span><span class="p">,</span>
            <span class="s2">&quot;usesPeriodic&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
    <span class="n">bonds</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="s2">&quot;Bonds&quot;</span><span class="p">)</span>

    <span class="n">ligand_bonds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ligand</span> <span class="ow">in</span> <span class="n">ligands</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ligand</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Forces/Force&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;HarmonicBondForce&quot;</span><span class="p">:</span>
                <span class="n">ligand_bonds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ligand_bonds</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ligands</span><span class="p">)</span>

    <span class="n">bonds_not_scale</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">ligands</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">ligand</span><span class="p">,</span> <span class="n">bond</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ligands</span><span class="p">,</span> <span class="n">bonds_not_scale</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">ligand</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./BondedTerms/Bond&quot;</span><span class="p">):</span>
            <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p1&quot;</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p2&quot;</span><span class="p">))</span>
            <span class="n">bond</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">))</span>
            <span class="n">bond</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">i2</span><span class="p">,</span> <span class="n">i1</span><span class="p">))</span>

    <span class="n">env_bonds</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">environment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">environment</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Forces/Force&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;HarmonicBondForce&quot;</span><span class="p">:</span>
                <span class="n">env_bonds</span> <span class="o">=</span> <span class="n">f</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">lambda_vdw</span><span class="p">),</span> <span class="n">ligand_bond</span><span class="p">,</span> <span class="n">ligand</span><span class="p">,</span> <span class="n">bond_no_scale</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
        <span class="n">lambdas</span><span class="p">,</span> <span class="n">ligand_bonds</span><span class="p">,</span> <span class="n">ligands</span><span class="p">,</span> <span class="n">bonds_not_scale</span>
    <span class="p">):</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">ligand_bond</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Bonds/Bond&quot;</span><span class="p">):</span>
            <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p1&quot;</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p2&quot;</span><span class="p">))</span>
            <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span> <span class="o">=</span> <span class="n">_get_idx</span><span class="p">(</span><span class="n">ligand</span><span class="p">,</span> <span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">])</span>
            <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">j1</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">j2</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">ligand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;common&quot;</span>
                <span class="ow">and</span> <span class="n">ligand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i2</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;common&quot;</span>
            <span class="p">):</span>
                <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span>
                    <span class="n">bonds</span><span class="p">,</span>
                    <span class="s2">&quot;Bond&quot;</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">))</span> <span class="o">*</span> <span class="n">lambda_vdw</span><span class="p">),</span>
                        <span class="s2">&quot;p1&quot;</span><span class="p">:</span> <span class="n">j1</span><span class="p">,</span>
                        <span class="s2">&quot;p2&quot;</span><span class="p">:</span> <span class="n">j2</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="p">(</span>
                <span class="n">ligand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;soft-core&quot;</span>
                <span class="ow">and</span> <span class="n">ligand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i2</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;soft-core&quot;</span>
            <span class="p">):</span>
                <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span>
                    <span class="n">bonds</span><span class="p">,</span>
                    <span class="s2">&quot;Bond&quot;</span><span class="p">,</span>
                    <span class="p">{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">),</span> <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">))),</span> <span class="s2">&quot;p1&quot;</span><span class="p">:</span> <span class="n">j1</span><span class="p">,</span> <span class="s2">&quot;p2&quot;</span><span class="p">:</span> <span class="n">j2</span><span class="p">},</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">bond_no_scale</span><span class="p">:</span>
                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span>
                        <span class="n">bonds</span><span class="p">,</span>
                        <span class="s2">&quot;Bond&quot;</span><span class="p">,</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">),</span>
                            <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">))),</span>
                            <span class="s2">&quot;p1&quot;</span><span class="p">:</span> <span class="n">j1</span><span class="p">,</span>
                            <span class="s2">&quot;p2&quot;</span><span class="p">:</span> <span class="n">j2</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span>
                        <span class="n">bonds</span><span class="p">,</span>
                        <span class="s2">&quot;Bond&quot;</span><span class="p">,</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">),</span>
                            <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">))),</span>
                            <span class="s2">&quot;p1&quot;</span><span class="p">:</span> <span class="n">j1</span><span class="p">,</span>
                            <span class="s2">&quot;p2&quot;</span><span class="p">:</span> <span class="n">j2</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">)</span>

    <span class="k">if</span> <span class="n">env_bonds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">env_bonds</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Bonds/Bond&quot;</span><span class="p">):</span>
            <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p1&quot;</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p2&quot;</span><span class="p">))</span>
            <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span> <span class="o">=</span> <span class="n">_get_idx</span><span class="p">(</span><span class="n">environment</span><span class="p">,</span> <span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">])</span>
            <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">j1</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">j2</span><span class="p">)</span>
            <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span>
                <span class="n">bonds</span><span class="p">,</span> <span class="s2">&quot;Bond&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">),</span> <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">),</span> <span class="s2">&quot;p1&quot;</span><span class="p">:</span> <span class="n">j1</span><span class="p">,</span> <span class="s2">&quot;p2&quot;</span><span class="p">:</span> <span class="n">j2</span><span class="p">}</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">force</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_merge_harmonic_angles</span><span class="p">(</span>
    <span class="n">ligands</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">],</span>
    <span class="n">lambdas</span><span class="p">:</span> <span class="nb">list</span><span class="p">[(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
    <span class="n">environment</span><span class="p">:</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">:</span>
    <span class="n">force</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span>
        <span class="s2">&quot;Force&quot;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;forceGroup&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;HarmonicAngleForce&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;HarmonicAngleForce&quot;</span><span class="p">,</span>
            <span class="s2">&quot;usesPeriodic&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="s2">&quot;Angles&quot;</span><span class="p">)</span>

    <span class="n">ligand_angles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ligand</span> <span class="ow">in</span> <span class="n">ligands</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ligand</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Forces/Force&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;HarmonicAngleForce&quot;</span><span class="p">:</span>
                <span class="n">ligand_angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ligand_angles</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ligands</span><span class="p">)</span>

    <span class="n">angles_not_scale</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">ligands</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">ligand</span><span class="p">,</span> <span class="n">angle</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ligands</span><span class="p">,</span> <span class="n">angles_not_scale</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ligand</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./BondedTerms/Angle&quot;</span><span class="p">):</span>
            <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">i3</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p1&quot;</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p2&quot;</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p3&quot;</span><span class="p">))</span>
            <span class="n">angle</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">i3</span><span class="p">))</span>
            <span class="n">angle</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">i3</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">i1</span><span class="p">))</span>

    <span class="n">env_angles</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">environment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">environment</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Forces/Force&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;HarmonicAngleForce&quot;</span><span class="p">:</span>
                <span class="n">env_angles</span> <span class="o">=</span> <span class="n">f</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">lambda_vdw</span><span class="p">),</span> <span class="n">ligand_angle</span><span class="p">,</span> <span class="n">ligand</span><span class="p">,</span> <span class="n">angle_not_scale</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
        <span class="n">lambdas</span><span class="p">,</span> <span class="n">ligand_angles</span><span class="p">,</span> <span class="n">ligands</span><span class="p">,</span> <span class="n">angles_not_scale</span>
    <span class="p">):</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ligand_angle</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Angles/Angle&quot;</span><span class="p">):</span>
            <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">i3</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p1&quot;</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p2&quot;</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p3&quot;</span><span class="p">))</span>
            <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">,</span> <span class="n">j3</span> <span class="o">=</span> <span class="n">_get_idx</span><span class="p">(</span><span class="n">ligand</span><span class="p">,</span> <span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">i3</span><span class="p">])</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">ligand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;common&quot;</span>
                <span class="ow">and</span> <span class="n">ligand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i2</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;common&quot;</span>
                <span class="ow">and</span> <span class="n">ligand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i3</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;common&quot;</span>
            <span class="p">):</span>
                <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span>
                    <span class="n">angles</span><span class="p">,</span>
                    <span class="s2">&quot;Angle&quot;</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">))),</span>
                        <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">))</span> <span class="o">*</span> <span class="n">lambda_vdw</span><span class="p">),</span>
                        <span class="s2">&quot;p1&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j1</span><span class="p">),</span>
                        <span class="s2">&quot;p2&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j2</span><span class="p">),</span>
                        <span class="s2">&quot;p3&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j3</span><span class="p">),</span>
                    <span class="p">},</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="n">ligand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;soft-core&quot;</span>
                <span class="ow">and</span> <span class="n">ligand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i2</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;soft-core&quot;</span>
                <span class="ow">and</span> <span class="n">ligand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i3</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;soft-core&quot;</span>
            <span class="p">):</span>
                <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span>
                    <span class="n">angles</span><span class="p">,</span>
                    <span class="s2">&quot;Angle&quot;</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">))),</span>
                        <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">))),</span>
                        <span class="s2">&quot;p1&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j1</span><span class="p">),</span>
                        <span class="s2">&quot;p2&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j2</span><span class="p">),</span>
                        <span class="s2">&quot;p3&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j3</span><span class="p">),</span>
                    <span class="p">},</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">i3</span><span class="p">)</span> <span class="ow">in</span> <span class="n">angle_not_scale</span><span class="p">:</span>
                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span>
                        <span class="n">angles</span><span class="p">,</span>
                        <span class="s2">&quot;Angle&quot;</span><span class="p">,</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">))),</span>
                            <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">))),</span>
                            <span class="s2">&quot;p1&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j1</span><span class="p">),</span>
                            <span class="s2">&quot;p2&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j2</span><span class="p">),</span>
                            <span class="s2">&quot;p3&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j3</span><span class="p">),</span>
                        <span class="p">},</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span>
                        <span class="n">angles</span><span class="p">,</span>
                        <span class="s2">&quot;Angle&quot;</span><span class="p">,</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">))),</span>
                            <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">))),</span>
                            <span class="s2">&quot;p1&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j1</span><span class="p">),</span>
                            <span class="s2">&quot;p2&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j2</span><span class="p">),</span>
                            <span class="s2">&quot;p3&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j3</span><span class="p">),</span>
                        <span class="p">},</span>
                    <span class="p">)</span>

    <span class="k">if</span> <span class="n">env_angles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">env_angles</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Angles/Angle&quot;</span><span class="p">):</span>
            <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">i3</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p1&quot;</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p2&quot;</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p3&quot;</span><span class="p">))</span>
            <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">,</span> <span class="n">j3</span> <span class="o">=</span> <span class="n">_get_idx</span><span class="p">(</span><span class="n">environment</span><span class="p">,</span> <span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">i3</span><span class="p">])</span>

            <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span>
                <span class="n">angles</span><span class="p">,</span>
                <span class="s2">&quot;Angle&quot;</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">))),</span>
                    <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">))),</span>
                    <span class="s2">&quot;p1&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j1</span><span class="p">),</span>
                    <span class="s2">&quot;p2&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j2</span><span class="p">),</span>
                    <span class="s2">&quot;p3&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j3</span><span class="p">),</span>
                <span class="p">},</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">force</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_merge_periodic_torsions</span><span class="p">(</span>
    <span class="n">ligands</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">],</span>
    <span class="n">lambdas</span><span class="p">:</span> <span class="nb">list</span><span class="p">[(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
    <span class="n">environment</span><span class="p">:</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">:</span>
    <span class="n">force</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span>
        <span class="s2">&quot;Force&quot;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;forceGroup&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;PeridociTorsionForce&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;PeriodicTorsionForce&quot;</span><span class="p">,</span>
            <span class="s2">&quot;usesPeriodic&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
    <span class="n">torsions</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="s2">&quot;Torsions&quot;</span><span class="p">)</span>

    <span class="n">ligand_torsions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ligand</span> <span class="ow">in</span> <span class="n">ligands</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ligand</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Forces/Force&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;PeriodicTorsionForce&quot;</span><span class="p">:</span>
                <span class="n">ligand_torsions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ligand_torsions</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ligands</span><span class="p">)</span>

    <span class="n">torsions_not_scale</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">ligands</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">ligand</span><span class="p">,</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ligands</span><span class="p">,</span> <span class="n">torsions_not_scale</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ligand</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./BondedTerms/Torsion&quot;</span><span class="p">):</span>
            <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">i3</span><span class="p">,</span> <span class="n">i4</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p1&quot;</span><span class="p">)),</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p2&quot;</span><span class="p">)),</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p3&quot;</span><span class="p">)),</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p4&quot;</span><span class="p">)),</span>
            <span class="p">)</span>
            <span class="n">torsion</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">i3</span><span class="p">,</span> <span class="n">i4</span><span class="p">))</span>
            <span class="n">torsion</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">i4</span><span class="p">,</span> <span class="n">i3</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">i1</span><span class="p">))</span>

    <span class="n">env_torsion</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">environment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">environment</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Forces/Force&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;PeriodicTorsionForce&quot;</span><span class="p">:</span>
                <span class="n">env_torsion</span> <span class="o">=</span> <span class="n">f</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">lambda_vdw</span><span class="p">),</span> <span class="n">ligand_torsion</span><span class="p">,</span> <span class="n">ligand</span><span class="p">,</span> <span class="n">torsion_not_scale</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
        <span class="n">lambdas</span><span class="p">,</span> <span class="n">ligand_torsions</span><span class="p">,</span> <span class="n">ligands</span><span class="p">,</span> <span class="n">torsions_not_scale</span>
    <span class="p">):</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ligand_torsion</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Torsions/Torsion&quot;</span><span class="p">):</span>
            <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">i3</span><span class="p">,</span> <span class="n">i4</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span>
                <span class="nb">int</span><span class="p">,</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p1&quot;</span><span class="p">),</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p2&quot;</span><span class="p">),</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p3&quot;</span><span class="p">),</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p4&quot;</span><span class="p">)]</span>
            <span class="p">)</span>
            <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">,</span> <span class="n">j3</span><span class="p">,</span> <span class="n">j4</span> <span class="o">=</span> <span class="n">_get_idx</span><span class="p">(</span><span class="n">ligand</span><span class="p">,</span> <span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">i3</span><span class="p">,</span> <span class="n">i4</span><span class="p">])</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">ligand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;common&quot;</span>
                <span class="ow">and</span> <span class="n">ligand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i2</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;common&quot;</span>
                <span class="ow">and</span> <span class="n">ligand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i3</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;common&quot;</span>
                <span class="ow">and</span> <span class="n">ligand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i4</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;common&quot;</span>
            <span class="p">):</span>
                <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span>
                    <span class="n">torsions</span><span class="p">,</span>
                    <span class="s2">&quot;Torsion&quot;</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">))</span> <span class="o">*</span> <span class="n">lambda_vdw</span><span class="p">),</span>
                        <span class="s2">&quot;p1&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j1</span><span class="p">),</span>
                        <span class="s2">&quot;p2&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j2</span><span class="p">),</span>
                        <span class="s2">&quot;p3&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j3</span><span class="p">),</span>
                        <span class="s2">&quot;p4&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j4</span><span class="p">),</span>
                        <span class="s2">&quot;periodicity&quot;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;periodicity&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phase&quot;</span><span class="p">),</span>
                    <span class="p">},</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="n">ligand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;soft-core&quot;</span>
                <span class="ow">and</span> <span class="n">ligand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i2</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;soft-core&quot;</span>
                <span class="ow">and</span> <span class="n">ligand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i3</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;soft-core&quot;</span>
                <span class="ow">and</span> <span class="n">ligand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i4</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;soft-core&quot;</span>
            <span class="p">):</span>
                <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span>
                    <span class="n">torsions</span><span class="p">,</span>
                    <span class="s2">&quot;Torsion&quot;</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">))),</span>
                        <span class="s2">&quot;p1&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j1</span><span class="p">),</span>
                        <span class="s2">&quot;p2&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j2</span><span class="p">),</span>
                        <span class="s2">&quot;p3&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j3</span><span class="p">),</span>
                        <span class="s2">&quot;p4&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j4</span><span class="p">),</span>
                        <span class="s2">&quot;periodicity&quot;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;periodicity&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phase&quot;</span><span class="p">),</span>
                    <span class="p">},</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">i3</span><span class="p">,</span> <span class="n">i4</span><span class="p">)</span> <span class="ow">in</span> <span class="n">torsion_not_scale</span><span class="p">:</span>
                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span>
                        <span class="n">torsions</span><span class="p">,</span>
                        <span class="s2">&quot;Torsion&quot;</span><span class="p">,</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">))),</span>
                            <span class="s2">&quot;p1&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j1</span><span class="p">),</span>
                            <span class="s2">&quot;p2&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j2</span><span class="p">),</span>
                            <span class="s2">&quot;p3&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j3</span><span class="p">),</span>
                            <span class="s2">&quot;p4&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j4</span><span class="p">),</span>
                            <span class="s2">&quot;periodicity&quot;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;periodicity&quot;</span><span class="p">),</span>
                            <span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phase&quot;</span><span class="p">),</span>
                        <span class="p">},</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span>
                        <span class="n">torsions</span><span class="p">,</span>
                        <span class="s2">&quot;Torsion&quot;</span><span class="p">,</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">))),</span>
                            <span class="s2">&quot;p1&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j1</span><span class="p">),</span>
                            <span class="s2">&quot;p2&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j2</span><span class="p">),</span>
                            <span class="s2">&quot;p3&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j3</span><span class="p">),</span>
                            <span class="s2">&quot;p4&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j4</span><span class="p">),</span>
                            <span class="s2">&quot;periodicity&quot;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;periodicity&quot;</span><span class="p">),</span>
                            <span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phase&quot;</span><span class="p">),</span>
                        <span class="p">},</span>
                    <span class="p">)</span>

    <span class="k">if</span> <span class="n">env_torsion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">env_torsion</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Torsions/Torsion&quot;</span><span class="p">):</span>
            <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">i3</span><span class="p">,</span> <span class="n">i4</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span>
                <span class="nb">int</span><span class="p">,</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p1&quot;</span><span class="p">),</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p2&quot;</span><span class="p">),</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p3&quot;</span><span class="p">),</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p4&quot;</span><span class="p">)]</span>
            <span class="p">)</span>
            <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">,</span> <span class="n">j3</span><span class="p">,</span> <span class="n">j4</span> <span class="o">=</span> <span class="n">_get_idx</span><span class="p">(</span><span class="n">environment</span><span class="p">,</span> <span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">i3</span><span class="p">,</span> <span class="n">i4</span><span class="p">])</span>

            <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span>
                <span class="n">torsions</span><span class="p">,</span>
                <span class="s2">&quot;Torsion&quot;</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">))),</span>
                    <span class="s2">&quot;p1&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j1</span><span class="p">),</span>
                    <span class="s2">&quot;p2&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j2</span><span class="p">),</span>
                    <span class="s2">&quot;p3&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j3</span><span class="p">),</span>
                    <span class="s2">&quot;p4&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j4</span><span class="p">),</span>
                    <span class="s2">&quot;periodicity&quot;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;periodicity&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phase&quot;</span><span class="p">),</span>
                <span class="p">},</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">force</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_merge_nonbonded_forces</span><span class="p">(</span>
    <span class="n">ligands</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">],</span>
    <span class="n">lambdas</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">environment</span><span class="p">:</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">environment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">environment</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Forces/Force&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;NonbondedForce&quot;</span><span class="p">:</span>
                <span class="n">attrib</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">attrib</span>
        <span class="c1"># attrib[&quot;dispersionCorrection&quot;] = &quot;0&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ligands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Forces/Force&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;NonbondedForce&quot;</span><span class="p">:</span>
                <span class="n">attrib</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">attrib</span>

    <span class="n">force</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;Force&quot;</span><span class="p">,</span> <span class="n">attrib</span><span class="p">)</span>
    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="s2">&quot;GlobalParameters&quot;</span><span class="p">)</span>
    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="s2">&quot;ParticleOffsets&quot;</span><span class="p">)</span>
    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="s2">&quot;ExceptionOffsets&quot;</span><span class="p">)</span>

    <span class="n">particles</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="s2">&quot;Particles&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ligand</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ligands</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ligand</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Particles/Particle&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1">## all all particles from the first ligand</span>
                <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span>
                    <span class="n">particles</span><span class="p">,</span> <span class="s2">&quot;Particle&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;eps&quot;</span><span class="p">:</span> <span class="s2">&quot;0.0&quot;</span><span class="p">,</span> <span class="s2">&quot;q&quot;</span><span class="p">:</span> <span class="s2">&quot;0.0&quot;</span><span class="p">,</span> <span class="s2">&quot;sig&quot;</span><span class="p">:</span> <span class="s2">&quot;0.0&quot;</span><span class="p">}</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;soft-core&quot;</span><span class="p">:</span>
                <span class="c1">## only add soft-core particles from other ligands</span>
                <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span>
                    <span class="n">particles</span><span class="p">,</span>
                    <span class="s2">&quot;Particle&quot;</span><span class="p">,</span>
                    <span class="p">{</span><span class="s2">&quot;eps&quot;</span><span class="p">:</span> <span class="s2">&quot;0.0&quot;</span><span class="p">,</span> <span class="s2">&quot;q&quot;</span><span class="p">:</span> <span class="s2">&quot;0.0&quot;</span><span class="p">,</span> <span class="s2">&quot;sig&quot;</span><span class="p">:</span> <span class="s2">&quot;0.0&quot;</span><span class="p">},</span>
                <span class="p">)</span>

    <span class="k">if</span> <span class="n">environment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1">## add environment particles</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">environment</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Particles/Particle&quot;</span><span class="p">):</span>
            <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span>
                <span class="n">particles</span><span class="p">,</span> <span class="s2">&quot;Particle&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;eps&quot;</span><span class="p">:</span> <span class="s2">&quot;0.0&quot;</span><span class="p">,</span> <span class="s2">&quot;q&quot;</span><span class="p">:</span> <span class="s2">&quot;0.0&quot;</span><span class="p">,</span> <span class="s2">&quot;sig&quot;</span><span class="p">:</span> <span class="s2">&quot;0.0&quot;</span><span class="p">}</span>
            <span class="p">)</span>

    <span class="n">ligand_nfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ligand</span> <span class="ow">in</span> <span class="n">ligands</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ligand</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Forces/Force&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;NonbondedForce&quot;</span><span class="p">:</span>
                <span class="n">ligand_nfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ligand_nfs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ligands</span><span class="p">)</span>

    <span class="n">env_nf</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">environment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">environment</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Forces/Force&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;NonbondedForce&quot;</span><span class="p">:</span>
                <span class="n">env_nf</span> <span class="o">=</span> <span class="n">f</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">lambda_elec</span><span class="p">,</span> <span class="n">lambda_vdw</span><span class="p">),</span> <span class="n">lig_nf</span><span class="p">,</span> <span class="n">ligand</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lambdas</span><span class="p">,</span> <span class="n">ligand_nfs</span><span class="p">,</span> <span class="n">ligands</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lig_nf</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Particles/Particle&quot;</span><span class="p">)):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ligand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">))</span>

            <span class="c1">## if the ligand particle is a common particle, scale eps, sig and q using svdw</span>
            <span class="c1">## this will allow us to change atom types of common particles</span>
            <span class="k">if</span> <span class="n">ligand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;common&quot;</span><span class="p">:</span>
                <span class="n">eps</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;eps&quot;</span><span class="p">))</span> <span class="o">*</span> <span class="n">lambda_vdw</span>
                <span class="n">q</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">))</span> <span class="o">*</span> <span class="n">lambda_vdw</span>
                <span class="n">sigma</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sig&quot;</span><span class="p">))</span> <span class="o">*</span> <span class="n">lambda_vdw</span>

                <span class="n">current_eps</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">particles</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;eps&quot;</span><span class="p">))</span>
                <span class="n">current_q</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">particles</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">))</span>
                <span class="n">current_sigma</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">particles</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sig&quot;</span><span class="p">))</span>

                <span class="n">particles</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;eps&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_eps</span> <span class="o">+</span> <span class="n">eps</span><span class="p">))</span>
                <span class="n">particles</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_q</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span>
                <span class="n">particles</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;sig&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_sigma</span> <span class="o">+</span> <span class="n">sigma</span><span class="p">))</span>

            <span class="c1">## if the ligand particle is a soft-core particle, set eps to 0 and sig to 1 and</span>
            <span class="c1">## scale its charge using selec.</span>
            <span class="c1">## To maintain the net charge, the charge that is removed from a soft-core particle is ## added to the common particle through which the soft-core particle</span>
            <span class="c1">## is connected to the common substructure.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">particles</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;eps&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
                <span class="n">particles</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;sig&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span>

                <span class="n">q</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">))</span>

                <span class="c1">## set the charge of the alchemical particle</span>
                <span class="n">particles</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="n">lambda_elec</span><span class="p">))</span>

                <span class="c1">## set the charge of the attached common particle</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">ligand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;attach_idx&quot;</span><span class="p">)</span>
                <span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ligand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">))</span>
                <span class="n">current_q</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">particles</span><span class="p">[</span><span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">))</span>
                <span class="n">particles</span><span class="p">[</span><span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                    <span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_q</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">lambda_elec</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">lambda_vdw</span><span class="p">)</span>
                <span class="p">)</span>

    <span class="k">if</span> <span class="n">env_nf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">env_nf</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Particles/Particle&quot;</span><span class="p">)):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">))</span>
            <span class="n">particles</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;eps&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;eps&quot;</span><span class="p">))</span>
            <span class="n">particles</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;sig&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sig&quot;</span><span class="p">))</span>
            <span class="n">particles</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">))</span>

    <span class="c1">## exceptions</span>
    <span class="n">exception_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;eps&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;q&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;sig&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">lambda_elec</span><span class="p">,</span> <span class="n">lambda_vdw</span><span class="p">),</span> <span class="n">lig_nf</span><span class="p">,</span> <span class="n">ligand</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lambdas</span><span class="p">,</span> <span class="n">ligand_nfs</span><span class="p">,</span> <span class="n">ligands</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">lig_nf</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Exceptions/Exception&quot;</span><span class="p">):</span>
            <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p1&quot;</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p2&quot;</span><span class="p">))</span>
            <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span> <span class="o">=</span> <span class="n">_get_idx</span><span class="p">(</span><span class="n">ligand</span><span class="p">,</span> <span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">])</span>
            <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">])</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">ligand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;common&quot;</span>
                <span class="ow">and</span> <span class="n">ligand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i2</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;common&quot;</span>
            <span class="p">):</span>
                <span class="n">exception_dict</span><span class="p">[(</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">)][</span><span class="s2">&quot;eps&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;eps&quot;</span><span class="p">))</span> <span class="o">*</span> <span class="n">lambda_vdw</span>
                <span class="n">exception_dict</span><span class="p">[(</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">)][</span><span class="s2">&quot;q&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">))</span> <span class="o">*</span> <span class="n">lambda_vdw</span>
                <span class="n">exception_dict</span><span class="p">[(</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">)][</span><span class="s2">&quot;sig&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sig&quot;</span><span class="p">))</span> <span class="o">*</span> <span class="n">lambda_vdw</span>

            <span class="k">elif</span> <span class="p">(</span>
                <span class="n">ligand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;soft-core&quot;</span>
                <span class="ow">and</span> <span class="n">ligand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i2</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;soft-core&quot;</span>
            <span class="p">):</span>
                <span class="n">exception_dict</span><span class="p">[(</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">)][</span><span class="s2">&quot;eps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;eps&quot;</span><span class="p">))</span>
                <span class="n">exception_dict</span><span class="p">[(</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">)][</span><span class="s2">&quot;q&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">))</span>
                <span class="n">exception_dict</span><span class="p">[(</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">)][</span><span class="s2">&quot;sig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sig&quot;</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">exception_dict</span><span class="p">[(</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">)][</span><span class="s2">&quot;eps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;eps&quot;</span><span class="p">))</span> <span class="o">*</span> <span class="n">lambda_vdw</span>
                <span class="n">exception_dict</span><span class="p">[(</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">)][</span><span class="s2">&quot;q&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">))</span> <span class="o">*</span> <span class="n">lambda_vdw</span>
                <span class="n">exception_dict</span><span class="p">[(</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">)][</span><span class="s2">&quot;sig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sig&quot;</span><span class="p">))</span>

    <span class="c1">## exceptions for soft-core particles from different ligands</span>
    <span class="k">for</span> <span class="n">liganda</span><span class="p">,</span> <span class="n">ligandb</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">ligands</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span>
            <span class="n">liganda</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Particles/Particle&quot;</span><span class="p">),</span>
            <span class="n">ligandb</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Particles/Particle&quot;</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;soft-core&quot;</span> <span class="ow">and</span> <span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;soft-core&quot;</span><span class="p">:</span>
                <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">))</span>
                <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">])</span>
                <span class="n">exception_dict</span><span class="p">[(</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">)][</span><span class="s2">&quot;eps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">exception_dict</span><span class="p">[(</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">)][</span><span class="s2">&quot;q&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">exception_dict</span><span class="p">[(</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">)][</span><span class="s2">&quot;sig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">env_nf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">env_nf</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Exceptions/Exception&quot;</span><span class="p">):</span>
            <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p1&quot;</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p2&quot;</span><span class="p">))</span>
            <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span> <span class="o">=</span> <span class="n">_get_idx</span><span class="p">(</span><span class="n">environment</span><span class="p">,</span> <span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">])</span>
            <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">])</span>
            <span class="n">exception_dict</span><span class="p">[(</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">)][</span><span class="s2">&quot;eps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;eps&quot;</span><span class="p">))</span>
            <span class="n">exception_dict</span><span class="p">[(</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">)][</span><span class="s2">&quot;q&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">))</span>
            <span class="n">exception_dict</span><span class="p">[(</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">)][</span><span class="s2">&quot;sig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sig&quot;</span><span class="p">))</span>

    <span class="n">exceptions</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="s2">&quot;Exceptions&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">),</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">exception_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span>
            <span class="n">exceptions</span><span class="p">,</span>
            <span class="s2">&quot;Exception&quot;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;eps&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s2">&quot;eps&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;p1&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j1</span><span class="p">),</span>
                <span class="s2">&quot;p2&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j2</span><span class="p">),</span>
                <span class="s2">&quot;q&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s2">&quot;q&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;sig&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s2">&quot;sig&quot;</span><span class="p">]),</span>
            <span class="p">},</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">force</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_make_custom_nonbonded_force</span><span class="p">(</span>
    <span class="n">ligands</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">],</span>
    <span class="n">lambdas</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">environment</span><span class="p">:</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">:</span>
    <span class="n">formula</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;4*epsilon*lambda*(1/(alpha*(1-lambda) + (r/sigma)^6)^2 - 1/(alpha*(1-lambda) + (r/sigma)^6))&quot;</span><span class="p">,</span>
        <span class="s2">&quot;epsilon = sqrt(eps1*eps2)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sigma = 0.5*(sig1+sig2)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;alpha = 0.5&quot;</span><span class="p">,</span>
        <span class="s2">&quot;lambda = select(group1*group2, lambda_b ,lambda_a)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;lambda_b = select(group1 - group2, 0, 1)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;lambda_a = lambda1 + lambda2&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">lig_nfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ligand</span> <span class="ow">in</span> <span class="n">ligands</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ligand</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Forces/Force&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;NonbondedForce&quot;</span><span class="p">:</span>
                <span class="n">lig_nfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">lig_nfs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ligands</span><span class="p">)</span>

    <span class="n">env_nf</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">environment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;2&quot;</span>  <span class="c1">## 2: CutoffPeriodic</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">environment</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Forces/Force&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;NonbondedForce&quot;</span><span class="p">:</span>
                <span class="n">env_nf</span> <span class="o">=</span> <span class="n">f</span>
        <span class="n">cutoff</span> <span class="o">=</span> <span class="n">env_nf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cutoff&quot;</span><span class="p">)</span>
        <span class="n">switch_distance</span> <span class="o">=</span> <span class="n">env_nf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;switchingDistance&quot;</span><span class="p">)</span>
        <span class="n">long_range_correction</span> <span class="o">=</span> <span class="n">env_nf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dispersionCorrection&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>  <span class="c1">## 1: CutoffNonPeriodic</span>
        <span class="n">cutoff</span> <span class="o">=</span> <span class="n">lig_nfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cutoff&quot;</span><span class="p">)</span>
        <span class="n">switch_distance</span> <span class="o">=</span> <span class="n">lig_nfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;switchingDistance&quot;</span><span class="p">)</span>
        <span class="n">long_range_correction</span> <span class="o">=</span> <span class="n">lig_nfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dispersionCorrection&quot;</span><span class="p">)</span>

    <span class="n">force</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span>
        <span class="s2">&quot;Force&quot;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;cutoff&quot;</span><span class="p">:</span> <span class="n">cutoff</span><span class="p">,</span>
            <span class="s2">&quot;energy&quot;</span><span class="p">:</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">formula</span><span class="p">),</span>
            <span class="s2">&quot;forceGroup&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">method</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;CustomNonbondedForce&quot;</span><span class="p">,</span>
            <span class="s2">&quot;switchingDistance&quot;</span><span class="p">:</span> <span class="n">switch_distance</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;CustomNonbondedForce&quot;</span><span class="p">,</span>
            <span class="s2">&quot;useLongRangeCorrection&quot;</span><span class="p">:</span> <span class="n">long_range_correction</span><span class="p">,</span>
            <span class="s2">&quot;useSwitchingFunction&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="n">perparticle_parameters</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="s2">&quot;PerParticleParameters&quot;</span><span class="p">)</span>
    <span class="n">perparticle_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;Parameter&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;eps&quot;</span><span class="p">}))</span>
    <span class="n">perparticle_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;Parameter&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;sig&quot;</span><span class="p">}))</span>
    <span class="n">perparticle_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;Parameter&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;lambda&quot;</span><span class="p">}))</span>
    <span class="n">perparticle_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;Parameter&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;group&quot;</span><span class="p">}))</span>

    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="s2">&quot;GlobalParameters&quot;</span><span class="p">)</span>
    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="s2">&quot;ComputedValues&quot;</span><span class="p">)</span>
    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="s2">&quot;EnergyParameterDerivatives&quot;</span><span class="p">)</span>
    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="s2">&quot;Functions&quot;</span><span class="p">)</span>

    <span class="n">particles</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="s2">&quot;Particles&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ligand</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ligands</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ligand</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Particles/Particle&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">particles</span><span class="p">,</span> <span class="s2">&quot;Particle&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;param1&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;param2&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;soft-core&quot;</span><span class="p">:</span>
                <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">particles</span><span class="p">,</span> <span class="s2">&quot;Particle&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;param1&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;param2&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">})</span>

    <span class="k">if</span> <span class="n">environment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">environment</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Particles/Particle&quot;</span><span class="p">):</span>
            <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">particles</span><span class="p">,</span> <span class="s2">&quot;Particle&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;param1&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;param2&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">})</span>

    <span class="k">for</span> <span class="n">idx_lig</span><span class="p">,</span> <span class="p">((</span><span class="n">_</span><span class="p">,</span> <span class="n">lambda_vdw</span><span class="p">),</span> <span class="n">lig_nf</span><span class="p">,</span> <span class="n">ligand</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
        <span class="nb">zip</span><span class="p">(</span><span class="n">lambdas</span><span class="p">,</span> <span class="n">lig_nfs</span><span class="p">,</span> <span class="n">ligands</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lig_nf</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Particles/Particle&quot;</span><span class="p">)):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ligand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">))</span>
            <span class="n">eps</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;eps&quot;</span><span class="p">))</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sig&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">ligand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;common&quot;</span><span class="p">:</span>
                <span class="n">current_eps</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">particles</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;param1&quot;</span><span class="p">))</span>
                <span class="n">current_sigma</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">particles</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;param2&quot;</span><span class="p">))</span>

                <span class="n">particles</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;param1&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_eps</span> <span class="o">+</span> <span class="n">eps</span> <span class="o">*</span> <span class="n">lambda_vdw</span><span class="p">))</span>
                <span class="n">particles</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;param2&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_sigma</span> <span class="o">+</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">lambda_vdw</span><span class="p">))</span>
                <span class="n">particles</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;param3&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
                <span class="n">particles</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;param4&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">particles</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;param1&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">eps</span><span class="p">))</span>
                <span class="n">particles</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;param2&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>
                <span class="n">particles</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;param3&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">lambda_vdw</span><span class="p">))</span>
                <span class="n">particles</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;param4&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx_lig</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">env_nf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">env_nf</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Particles/Particle&quot;</span><span class="p">)):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./Particles&quot;</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">))</span>
            <span class="n">particles</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;param1&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;eps&quot;</span><span class="p">))</span>
            <span class="n">particles</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;param2&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sig&quot;</span><span class="p">))</span>
            <span class="n">particles</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;param3&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
            <span class="n">particles</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;param4&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>

    <span class="n">interaction_groups</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="s2">&quot;InteractionGroups&quot;</span><span class="p">)</span>
    <span class="n">interaction_group</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">interaction_groups</span><span class="p">,</span> <span class="s2">&quot;InteractionGroup&quot;</span><span class="p">)</span>
    <span class="n">set1</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">interaction_group</span><span class="p">,</span> <span class="s2">&quot;Set1&quot;</span><span class="p">)</span>
    <span class="n">set2</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">interaction_group</span><span class="p">,</span> <span class="s2">&quot;Set2&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ligand</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ligands</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ligand</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Particles/Particle&quot;</span><span class="p">):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;common&quot;</span><span class="p">:</span>
                <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">set2</span><span class="p">,</span> <span class="s2">&quot;Particle&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">j</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;soft-core&quot;</span><span class="p">:</span>
                <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">set1</span><span class="p">,</span> <span class="s2">&quot;Particle&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">j</span><span class="p">})</span>
                <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">set2</span><span class="p">,</span> <span class="s2">&quot;Particle&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">j</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;soft-core&quot;</span><span class="p">:</span>
                <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">set1</span><span class="p">,</span> <span class="s2">&quot;Particle&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">j</span><span class="p">})</span>
                <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">set2</span><span class="p">,</span> <span class="s2">&quot;Particle&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">j</span><span class="p">})</span>

    <span class="k">if</span> <span class="n">environment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">environment</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Particles/Particle&quot;</span><span class="p">):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">)</span>
            <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">set2</span><span class="p">,</span> <span class="s2">&quot;Particle&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">j</span><span class="p">})</span>

    <span class="c1">## add exclusions</span>
    <span class="c1">## Although some of the following exclusions seem not necessary given we are only using</span>
    <span class="c1">## the CustomNonbondedForce to compute the nonbonded interactions between soft-core particles</span>
    <span class="c1">## and the environment, we include them because OpenMM requires that all forces have the same</span>
    <span class="c1">## set of exclusions, i.e., the list of exceptions in the NonbondedForce should be the same as</span>
    <span class="c1">## the list of exclusions in the CustomNonbondedForce no matter the exception has a zero</span>
    <span class="c1">## chargeProd and sigma or not.</span>

    <span class="n">exclusions</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="s2">&quot;Exclusions&quot;</span><span class="p">)</span>
    <span class="n">exclusion_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="n">lig_nfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ligand</span> <span class="ow">in</span> <span class="n">ligands</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ligand</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Forces/Force&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;NonbondedForce&quot;</span><span class="p">:</span>
                <span class="n">lig_nfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">lig_nfs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ligands</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">lig_nf</span><span class="p">,</span> <span class="n">ligand</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lig_nfs</span><span class="p">,</span> <span class="n">ligands</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">lig_nf</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Exceptions/Exception&quot;</span><span class="p">):</span>
            <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p1&quot;</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p2&quot;</span><span class="p">))</span>
            <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span> <span class="o">=</span> <span class="n">_get_idx</span><span class="p">(</span><span class="n">ligand</span><span class="p">,</span> <span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">])</span>
            <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclusion_set</span><span class="p">:</span>
                <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">exclusions</span><span class="p">,</span> <span class="s2">&quot;Exclusion&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;p1&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j1</span><span class="p">),</span> <span class="s2">&quot;p2&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j2</span><span class="p">)})</span>
                <span class="n">exclusion_set</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">liganda</span><span class="p">,</span> <span class="n">ligandb</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">ligands</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span>
            <span class="n">liganda</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Particles/Particle&quot;</span><span class="p">),</span>
            <span class="n">ligandb</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Particles/Particle&quot;</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;soft-core&quot;</span> <span class="ow">and</span> <span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;soft-core&quot;</span><span class="p">:</span>
                <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">))</span>
                <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">])</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclusion_set</span><span class="p">:</span>
                    <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span>
                        <span class="n">exclusions</span><span class="p">,</span> <span class="s2">&quot;Exclusion&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;p1&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j1</span><span class="p">),</span> <span class="s2">&quot;p2&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j2</span><span class="p">)}</span>
                    <span class="p">)</span>
                    <span class="n">exclusion_set</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">env_nf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">env_nf</span><span class="o">.</span><span class="n">iterfind</span><span class="p">(</span><span class="s2">&quot;./Exceptions/Exception&quot;</span><span class="p">):</span>
            <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p1&quot;</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p2&quot;</span><span class="p">))</span>
            <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span> <span class="o">=</span> <span class="n">_get_idx</span><span class="p">(</span><span class="n">environment</span><span class="p">,</span> <span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">])</span>
            <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclusion_set</span><span class="p">:</span>
                <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">exclusions</span><span class="p">,</span> <span class="s2">&quot;Exclusion&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;p1&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j1</span><span class="p">),</span> <span class="s2">&quot;p2&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j2</span><span class="p">)})</span>
                <span class="n">exclusion_set</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">force</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_make_cmmotion_remover</span><span class="p">():</span>
    <span class="n">force</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span>
        <span class="s2">&quot;Force&quot;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;forceGroup&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;frequency&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;CMMotionRemover&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;CMMotionRemover&quot;</span><span class="p">,</span>
            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">force</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_increment_atom_name</span><span class="p">(</span><span class="n">atom_name</span><span class="p">):</span>
    <span class="c1"># Use regular expressions to find all non-digit and digit parts of the string</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;([a-zA-Z]+)(\d+)&quot;</span><span class="p">,</span> <span class="n">atom_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="n">letters</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">digits</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Increment the number part</span>
        <span class="n">new_number</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># zfill keeps the leading zeros</span>
        <span class="k">return</span> <span class="n">letters</span> <span class="o">+</span> <span class="n">new_number</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Return original if no digits found</span>
        <span class="k">return</span> <span class="n">atom_name</span> <span class="o">+</span> <span class="s2">&quot;1&quot;</span>
</pre></div>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Xinqiang Ding
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
       Copyright 2024, Xinqiang Ding.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>